---
// HeroSection.astro - Main hero section with magnetic text, particle trail, and liquid blobs
import FloatingShapesCanvas from '../features/FloatingShapesCanvas.astro';
import SoundEffectsProvider from '../providers/SoundEffectsProvider';
---

<section
  class="hero-section relative h-[calc(100vh-4rem)] flex items-center justify-center overflow-hidden"
>
  <SoundEffectsProvider client:load />
  <!-- Liquid blob background -->
  <div class="absolute inset-0 bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900">
    <div class="liquid-blobs absolute inset-0">
      <div class="blob blob-1"></div>
      <div class="blob blob-2"></div>
      <div class="blob blob-3"></div>
    </div>
  </div>

  <!-- Floating shapes canvas -->
  <FloatingShapesCanvas />

  <!-- Pop Counters Display -->
  <div class="absolute top-4 left-4 z-50 pointer-events-none">
    <div
      class="press-start-2p-font text-white text-xs sm:text-sm text-center"
      style="text-shadow: 2px 2px 4px rgba(0,0,0,0.8), 0 0 8px rgba(0,0,0,0.5);"
    >
      <div class="flex items-center justify-center gap-2 relative">
        <span id="player-label">Player</span>
        <span id="player-score-line" class="player-score-line"></span>
      </div>
      <div id="user-pop-count" class="text-yellow-300 mt-1" style="transform: translateX(-8px);">
        0
      </div>
    </div>
  </div>
  <div class="absolute top-4 right-4 z-50 pointer-events-none">
    <div
      class="press-start-2p-font text-white text-xs sm:text-sm text-center"
      style="text-shadow: 2px 2px 4px rgba(0,0,0,0.8), 0 0 8px rgba(0,0,0,0.5);"
    >
      <div class="flex items-center justify-center gap-2 relative">
        <span id="laser-status-dot" class="laser-status-dot"></span>
        <span id="laser-label">Laser</span>
        <span id="laser-score-line" class="laser-score-line"></span>
      </div>
      <div
        id="laser-pop-count"
        class="mt-1"
        style="color: rgba(255, 40, 40, 1); text-shadow: 0 0 4px rgba(255, 40, 40, 0.8), 0 0 8px rgba(255, 40, 40, 0.6);"
      >
        0
      </div>
    </div>
  </div>

  <!-- Particle trail canvas -->
  <canvas id="particleTrail" class="absolute inset-0 w-full h-full pointer-events-none"></canvas>
  <!-- Laser overlay canvas -->
  <canvas
    id="heroLaser"
    class="absolute inset-0 w-full h-full pointer-events-none z-40 block"
    style="opacity: 0;"></canvas>

  <!-- Sound Mute Button -->
  <button
    id="sound-mute-button"
    class="absolute bottom-4 right-4 z-50 p-2 rounded-full bg-black/40 hover:bg-black/60 backdrop-blur-sm transition-all duration-200 hover:scale-110 focus:outline-none focus:ring-2 focus:ring-white/50"
    aria-label="Toggle sound effects"
    title="Toggle sound effects"
  >
    <!-- Speaker icon (unmuted) -->
    <svg
      id="sound-icon-unmuted"
      class="w-6 h-6 text-white"
      fill="none"
      stroke="currentColor"
      viewBox="0 0 24 24"
      xmlns="http://www.w3.org/2000/svg"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"
      ></path>
    </svg>
    <!-- Speaker with slash icon (muted) -->
    <svg
      id="sound-icon-muted"
      class="w-6 h-6 text-white hidden"
      fill="none"
      stroke="currentColor"
      viewBox="0 0 24 24"
      xmlns="http://www.w3.org/2000/svg"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"
      ></path>
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2"></path>
    </svg>
  </button>

  <!-- Content -->
  <div
    class="relative z-10 text-center px-4 sm:px-6 lg:px-8 max-w-4xl mx-auto content-wrapper"
    style="isolation: isolate;"
  >
    <h1
      class="hero-title text-5xl sm:text-6xl lg:text-7xl font-bold mb-6 animate-slide-up bangers-font"
      style="text-shadow: 2px 2px 4px rgba(0,0,0,0.3), 0 0 20px rgba(0,0,0,0.5); text-transform: none; letter-spacing: 3px;"
    >
      <span
        class="magnetic-text"
        data-text="Stupid Web Tricks"
        style="color: #7661d1 !important; text-shadow: 2px 2px 4px rgba(0,0,0,0.5), 0 0 10px rgba(118, 97, 209, 0.3) !important;"
      >
        <span class="word word-stupid">Stupid</span>
        <span class="word word-web">Web</span>
        <span class="word word-tricks">Tricks</span>
      </span>
    </h1>
    <p
      class="hero-description text-xl sm:text-2xl text-gray-300 mb-8 animate-slide-up"
      style="animation-delay: 0.2s;"
    >
      Discover amazing web effects, animations,<br />
      and learn the techniques to create them!
    </p>
    <div class="animate-slide-up" style="animation-delay: 0.4s;">
      <a
        href="#categories"
        class="hero-button inline-flex items-center px-8 py-4 bg-gradient-to-r from-purple-600 to-blue-600 text-white font-semibold rounded-full hover:from-purple-700 hover:to-blue-700 transform hover:scale-105 transition-all duration-300 shadow-lg hover:shadow-xl cursor-pointer relative z-50"
      >
        Explore Tricks
        <svg class="ml-2 w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"
          ></path>
        </svg>
      </a>
    </div>
  </div>
</section>

<script>
  // @ts-nocheck
  // Initialize all hero section effects
  import { initHeroEffects } from '../../lib/hero/init.js';
  import { initSoundControl, toggleMute, isMuted } from '../../lib/utils/soundControl.js';

  // Initialize sound control
  initSoundControl();

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initHeroEffects);
  } else {
    // DOM already loaded, initialize immediately
    initHeroEffects();
  }

  // Setup mute button
  function setupMuteButton() {
    const muteButton = document.getElementById('sound-mute-button');
    const unmutedIcon = document.getElementById('sound-icon-unmuted');
    const mutedIcon = document.getElementById('sound-icon-muted');

    if (!muteButton || !unmutedIcon || !mutedIcon) {
      setTimeout(setupMuteButton, 100);
      return;
    }

    // Update icon based on current mute state
    function updateIcon() {
      const muted = isMuted();
      if (muted) {
        unmutedIcon?.classList.add('hidden');
        mutedIcon?.classList.remove('hidden');
      } else {
        unmutedIcon?.classList.remove('hidden');
        mutedIcon?.classList.add('hidden');
      }
    }

    // Set initial icon state
    updateIcon();

    // Handle button click
    muteButton.addEventListener('click', () => {
      toggleMute();
      updateIcon();
    });

    // Listen for mute state changes from other sources
    window.addEventListener('soundEffects:muteChanged', updateIcon);
  }

  // Setup mute button when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setupMuteButton);
  } else {
    setupMuteButton();
  }

  // Track laser winning state for 60-second timer
  let laserWinningStartTime = null;
  let laserLabelChanged = false;

  // Update pop counters display and laser status dot
  function updatePopCounters() {
    const userCountEl = document.getElementById('user-pop-count');
    const laserCountEl = document.getElementById('laser-pop-count');
    const laserDotEl = document.getElementById('laser-status-dot');
    const laserLabelEl = document.getElementById('laser-label');

    if (!userCountEl || !laserCountEl || !laserDotEl || !laserLabelEl) {
      setTimeout(updatePopCounters, 100);
      return;
    }

    const bubbles = window?.soapBubbles_floatingShapesCanvas;
    if (bubbles && typeof bubbles.getPopStats === 'function') {
      const stats = bubbles.getPopStats();
      userCountEl.textContent = stats.pointerPops.toString();
      laserCountEl.textContent = stats.laserPops.toString();

      // Track when laser is winning for 60 seconds
      const now = Date.now();
      if (stats.laserPops > stats.pointerPops) {
        // Laser is winning
        if (laserWinningStartTime === null) {
          laserWinningStartTime = now;
          console.log('Laser started winning, timer started');
        }

        const laserWinningDuration = now - laserWinningStartTime;
        const sixtySeconds = 60000;

        // Debug: log progress every 10 seconds
        if (laserWinningDuration > 0 && laserWinningDuration % 10000 < 100) {
          console.log(`Laser winning for ${Math.floor(laserWinningDuration / 1000)} seconds`);
        }

        // If laser has been winning for 60 seconds, change "Laser" to "Winner"
        if (laserWinningDuration >= sixtySeconds && !laserLabelChanged) {
          console.log('Laser has been winning for 60 seconds, changing label to Winner');
          laserLabelEl.textContent = 'Winner';
          laserLabelChanged = true;
        }
      } else {
        // Player is winning or tied - reset timer and label
        if (laserWinningStartTime !== null) {
          console.log('Laser no longer winning, resetting timer');
          laserWinningStartTime = null;
        }
        if (laserLabelChanged) {
          laserLabelEl.textContent = 'Laser';
          laserLabelChanged = false;
        }
      }

      // Show/hide laser score line based on score comparison
      const laserLineEl = document.getElementById('laser-score-line');
      if (laserLineEl) {
        if (stats.laserPops > stats.pointerPops) {
          laserLineEl.style.display = 'block';
        } else {
          laserLineEl.style.display = 'none';
        }
      }

      // Show/hide player score line based on score comparison
      const playerLineEl = document.getElementById('player-score-line');
      if (playerLineEl) {
        if (stats.pointerPops > stats.laserPops) {
          playerLineEl.style.display = 'block';
        } else {
          playerLineEl.style.display = 'none';
        }
      }
    }

    // Update laser status dot size based on firing rate
    // @ts-ignore
    const laserOverlay = window?.laserOverlay_instance;
    if (laserOverlay && laserOverlay.currentInterval !== undefined) {
      const baseInterval = 10000; // LASER_INTERVAL_MS (10 seconds)
      const currentInterval = laserOverlay.currentInterval;

      // Calculate size multiplier based on firing rate
      // Normal (10s): 1x (6px), Fast (5s): 2x (12px), Very Fast (2.5s): 4x (24px)
      let sizeMultiplier = 1;
      if (currentInterval <= baseInterval / 4 + 100) {
        // Very fast rate (2.5s) - 4x size
        sizeMultiplier = 4;
      } else if (currentInterval <= baseInterval / 2 + 100) {
        // Fast rate (5s) - 2x size
        sizeMultiplier = 2;
      } else {
        // Normal rate (10s) - 1x size
        sizeMultiplier = 1;
      }

      // Base size is 6px, scale by multiplier
      const dotSize = 6 * sizeMultiplier;
      laserDotEl.style.width = `${dotSize}px`;
      laserDotEl.style.height = `${dotSize}px`;
    }

    // Update every 100ms for real-time display
    setTimeout(updatePopCounters, 100);
  }

  // Start updating counters after a short delay to ensure bubbles are initialized
  setTimeout(updatePopCounters, 500);
</script>

<style>
  /* Press Start 2P font */
  .press-start-2p-font {
    font-family: 'Press Start 2P', 'Courier New', monospace;
    line-height: 1.6;
    letter-spacing: 0;
  }

  /* Laser status dot */
  .laser-status-dot {
    display: inline-block;
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background-color: rgba(255, 40, 40, 1);
    box-shadow:
      0 0 4px rgba(255, 40, 40, 0.8),
      0 0 8px rgba(255, 40, 40, 0.6),
      0 0 12px rgba(255, 40, 40, 0.4);
    transition:
      width 0.3s ease,
      height 0.3s ease,
      box-shadow 0.3s ease;
    flex-shrink: 0;
  }

  /* Laser score line - appears when laser is winning */
  .laser-score-line {
    position: absolute;
    bottom: -2px;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(
      to right,
      rgba(255, 120, 120, 0.7) 0%,
      rgba(255, 40, 40, 1) 50%,
      rgba(255, 120, 120, 0.7) 100%
    );
    box-shadow:
      0 0 4px rgba(255, 40, 40, 0.8),
      0 0 8px rgba(255, 60, 60, 0.6);
    display: none;
    transition: opacity 0.3s ease;
  }

  /* Player score line - appears when player is winning */
  .player-score-line {
    position: absolute;
    bottom: -2px;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(
      to right,
      rgba(255, 220, 120, 0.7) 0%,
      rgba(255, 200, 40, 1) 50%,
      rgba(255, 220, 120, 0.7) 100%
    );
    box-shadow:
      0 0 4px rgba(255, 200, 40, 0.8),
      0 0 8px rgba(255, 220, 60, 0.6);
    display: none;
    transition: opacity 0.3s ease;
  }

  /* Hero button styling */
  .hero-button {
    position: relative;
    z-index: 50;
    will-change: transform;
  }

  /* Content wrapper - isolates text from background blobs */
  .content-wrapper::before {
    content: '';
    position: absolute;
    inset: -50px;
    background: radial-gradient(ellipse at center, rgba(0, 0, 0, 0.2) 0%, transparent 70%);
    backdrop-filter: blur(1px);
    z-index: -1;
    pointer-events: none;
  }

  /* Magnetic text styling */
  .magnetic-text {
    display: inline-block;
    transition: transform 0.1s ease-out;
    will-change: transform;
    transform-style: preserve-3d;
    color: #7661d1 !important;
    filter: drop-shadow(2px 2px 4px rgba(0, 0, 0, 0.6)) drop-shadow(0 0 8px rgba(118, 97, 209, 0.4));
    -webkit-text-stroke: 1px rgba(255, 255, 255, 0.1);
  }

  /* Smooth transition only when actively transforming */
  .magnetic-text[style*='rotate'] {
    transition: transform 0.08s ease-out;
  }

  /* Word styling */
  .word {
    display: inline-block;
    transition: text-shadow 0.5s ease-in-out;
  }

  /* Jiggle animation for words */
  .word.jiggle {
    animation: jiggle 0.3s ease-in-out;
  }

  @keyframes jiggle {
    0%,
    100% {
      transform: translateX(0) translateY(0) rotate(0deg);
    }
    10% {
      transform: translateX(-2px) translateY(-1px) rotate(-1deg);
    }
    20% {
      transform: translateX(2px) translateY(1px) rotate(1deg);
    }
    30% {
      transform: translateX(-1px) translateY(1px) rotate(-0.5deg);
    }
    40% {
      transform: translateX(1px) translateY(-1px) rotate(0.5deg);
    }
    50% {
      transform: translateX(-1px) translateY(-1px) rotate(-0.5deg);
    }
    60% {
      transform: translateX(1px) translateY(1px) rotate(0.5deg);
    }
    70% {
      transform: translateX(-1px) translateY(0px) rotate(-0.3deg);
    }
    80% {
      transform: translateX(1px) translateY(0px) rotate(0.3deg);
    }
    90% {
      transform: translateX(0px) translateY(0px) rotate(0deg);
    }
  }

  /* Liquid blob animations */
  .liquid-blobs {
    filter: blur(40px);
    opacity: 0.9;
    z-index: 1;
  }

  .blob {
    position: absolute;
    border-radius: 50%;
    will-change: transform;
    z-index: 1;
  }

  .blob-1 {
    width: 800px;
    height: 800px;
    background: radial-gradient(circle, rgba(147, 51, 234, 0.95), rgba(79, 70, 229, 0.85));
    top: 5%;
    left: 0%;
    animation: blobFloat1 20s ease-in-out infinite;
  }

  .blob-2 {
    width: 900px;
    height: 900px;
    background: radial-gradient(circle, rgba(79, 70, 229, 0.95), rgba(59, 130, 246, 0.85));
    bottom: 5%;
    right: 0%;
    animation: blobFloat2 25s ease-in-out infinite;
  }

  .blob-3 {
    width: 700px;
    height: 700px;
    background: radial-gradient(circle, rgba(59, 130, 246, 0.9), rgba(37, 99, 235, 0.75));
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    animation: blobFloat3 30s ease-in-out infinite;
  }

  @keyframes blobFloat1 {
    0%,
    100% {
      transform: translate(0, 0) scale(1) rotate(0deg);
    }
    33% {
      transform: translate(120px, 80px) scale(1.2) rotate(120deg);
    }
    66% {
      transform: translate(-60px, 100px) scale(0.9) rotate(240deg);
    }
  }

  @keyframes blobFloat2 {
    0%,
    100% {
      transform: translate(0, 0) scale(1) rotate(0deg);
    }
    33% {
      transform: translate(-100px, -120px) scale(1.3) rotate(120deg);
    }
    66% {
      transform: translate(120px, -60px) scale(0.85) rotate(240deg);
    }
  }

  @keyframes blobFloat3 {
    0%,
    100% {
      transform: translate(-50%, -50%) scale(1) rotate(0deg);
    }
    33% {
      transform: translate(-45%, -60%) scale(1.3) rotate(120deg);
    }
    66% {
      transform: translate(-55%, -40%) scale(0.8) rotate(240deg);
    }
  }

  /* Floating shapes canvas - behind particles but above background */
  #floatingShapesCanvas {
    z-index: 4;
  }

  /* Particle canvas - on top so particles are visible */
  #particleTrail {
    z-index: 5;
  }

  .content-wrapper {
    user-select: none;
    -webkit-user-select: none;
    -ms-user-select: none;
  }

  .content-wrapper * {
    user-select: none;
    -webkit-user-select: none;
    -ms-user-select: none;
    cursor: default;
  }
</style>
