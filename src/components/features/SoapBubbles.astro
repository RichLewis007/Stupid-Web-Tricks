---
// SoapBubbles.astro - Standalone reusable soap bubble animation component
//
/**
 * Configuration options:
 * @property {string} containerSelector - CSS selector for the container to size/position the canvas (default: 'body').
 * @property {string} canvasId - Unique ID applied to the canvas element; used for DOM lookups (default: 'soapBubblesCanvas').
 * @property {number} bubbleCount - Number of large bubbles to render simultaneously (default: 6).
 * @property {number} minRadius - Minimum radius, in pixels, when creating new bubbles (default: 20).
 * @property {number} maxRadius - Maximum radius, in pixels, when creating new bubbles (default: 60).
 * @property {string[]} collisionSelectors - Elements that trigger a pop when touched (default: none).
 * @property {boolean} enableMousePop - Whether bubbles pop when clicked (default: true).
 * @property {boolean} enableMouseInteraction - Whether bubbles react to/are attracted to the mouse (default: true).
 * @property {number} zIndex - CSS z-index applied to the canvas (default: 3).
 * @property {string} pointerEvents - Pointer-event mode for the canvas (default: 'none').
 */
const {
  containerSelector = 'body',
  canvasId = 'soapBubblesCanvas',
  bubbleCount = 6,
  minRadius = 20,
  maxRadius = 60,
  collisionSelectors = [],
  enableMousePop = true,
  enableMouseInteraction = true,
  zIndex = 3,
  pointerEvents = 'none',
} = Astro.props;

// Pass config to the initialization script
const config = {
  containerSelector,
  canvasId,
  bubbleCount,
  minRadius,
  maxRadius,
  collisionSelectors,
  enableMousePop,
  enableMouseInteraction,
};
---

<canvas
  id={canvasId}
  class="soap-bubbles-canvas"
  data-config={JSON.stringify(config)}
  style={`z-index: ${zIndex}; pointer-events: ${pointerEvents};`}></canvas>

<script>
  // @ts-nocheck - TypeScript types for setTimeout vary by environment
  import { initSoapBubbles } from '../../lib/bubbles/init.js';

  // Track initialization state to prevent leaks
  let initTimeoutId = null;
  let domContentLoadedListener = null;
  let hasInitialized = false;

  // Find all uninitialized canvas elements and initialize them
  function initialize() {
    // Clear any pending timeout
    if (initTimeoutId !== null) {
      clearTimeout(initTimeoutId);
      initTimeoutId = null;
    }

    const canvases = document.querySelectorAll(
      '.soap-bubbles-canvas[data-config]:not([data-initialized])',
    );

    canvases.forEach((canvas) => {
      const canvasId = canvas.id;
      if (!canvasId) {
        console.warn('SoapBubbles: Canvas found without ID, skipping');
        return;
      }

      // Check if already initialized
      if (canvas.hasAttribute('data-initialized')) {
        return;
      }

      console.log(`SoapBubbles: Initializing for canvasId: ${canvasId}`);

      // Read config from data attribute
      const configJson = canvas.getAttribute('data-config');
      if (configJson) {
        try {
          const config = JSON.parse(configJson);
          console.log(`SoapBubbles: Config parsed for "${canvasId}"`, config);

          // Mark as initialized before calling init to prevent double initialization
          canvas.setAttribute('data-initialized', 'true');
          initSoapBubbles(config);
        } catch (e) {
          console.error('SoapBubbles: Failed to initialize', e);
        }
      } else {
        console.warn(`SoapBubbles: No data-config attribute found on canvas "${canvasId}"`);
      }
    });

    // If no canvases found yet and we haven't initialized, retry (with limit)
    if (canvases.length === 0 && !hasInitialized) {
      initTimeoutId = setTimeout(initialize, 100);
    } else if (canvases.length > 0) {
      hasInitialized = true;
    }
  }

  // Cleanup function
  function cleanup() {
    if (initTimeoutId !== null) {
      clearTimeout(initTimeoutId);
      initTimeoutId = null;
    }
    if (domContentLoadedListener) {
      document.removeEventListener('DOMContentLoaded', domContentLoadedListener);
      domContentLoadedListener = null;
    }
  }

  if (document.readyState === 'loading') {
    domContentLoadedListener = initialize;
    document.addEventListener('DOMContentLoaded', domContentLoadedListener);
  } else {
    initTimeoutId = setTimeout(initialize, 0);
  }

  // Cleanup on page unload
  window.addEventListener('beforeunload', cleanup);
</script>

<style>
  .soap-bubbles-canvas {
    position: absolute !important;
    top: 0 !important;
    left: 0 !important;
    right: 0 !important;
    bottom: 0 !important;
    width: 100% !important;
    height: 100% !important;
  }
</style>
